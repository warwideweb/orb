<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#03060E">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/orb-192.png">
<title>ORB</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --cyan:#00D4FF;--blue:#0066FF;--violet:#7B2FFF;--soft:#E0EEFF;
  --bg:#03060E;--text:rgba(255,255,255,.9);--dim:rgba(255,255,255,.25);
  --glass:rgba(255,255,255,0.06);--glass-border:rgba(255,255,255,0.08);
  --orb-size:min(72vw,72vh,360px);
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',system-ui,sans-serif;-webkit-tap-highlight-color:transparent;touch-action:manipulation;user-select:none}
body{display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(180deg,#050A18 0%,#03060E 100%)}
body::before{content:'';position:fixed;inset:0;pointer-events:none;opacity:0.02;z-index:1000;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}

/* Status bar */
.status{position:fixed;top:env(safe-area-inset-top,12px);left:0;right:0;display:flex;justify-content:flex-start;padding:14px 24px;font-size:11px;font-weight:300;color:var(--dim);opacity:0.25;z-index:100;letter-spacing:.5px}

/* Greeting */
.greeting{position:fixed;top:16%;left:0;right:0;text-align:center;font-size:clamp(16px,3.5vw,22px);font-weight:200;letter-spacing:2px;color:rgba(255,255,255,.35);opacity:0;animation:greetFade 4s ease forwards;pointer-events:none;z-index:5}
@keyframes greetFade{0%{opacity:0;transform:translateY(8px)}12%{opacity:1;transform:translateY(0)}70%{opacity:1}100%{opacity:0}}

/* Onboarding text */
.onboard-text{position:fixed;top:calc(50% + var(--orb-size)/2 + 40px);left:0;right:0;text-align:center;font-size:15px;font-weight:200;letter-spacing:3px;color:rgba(255,255,255,.5);opacity:0;transition:opacity .8s;pointer-events:none;z-index:50}

/* Orb container */
.orb-wrap{position:relative;width:var(--orb-size);height:var(--orb-size);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10}

/* Depth shadow */
.orb-shadow{position:absolute;bottom:-10%;left:15%;right:15%;height:15%;background:radial-gradient(ellipse at 50% 0%,rgba(0,0,0,0.25) 0%,transparent 70%);filter:blur(15px);pointer-events:none;z-index:0;opacity:0.6}

/* Ambient glow */
.orb-glow{position:absolute;width:150%;height:150%;border-radius:50%;background:radial-gradient(circle,rgba(0,180,255,.12) 0%,rgba(123,47,255,.06) 40%,transparent 70%);filter:blur(50px);pointer-events:none;z-index:1;transition:opacity .4s}

/* Main canvas */
#orbCanvas{position:absolute;inset:0;width:100%;height:100%;z-index:2}

/* Radial menu */
.radial-menu{position:absolute;width:100%;height:100%;pointer-events:none;z-index:20}

/* App icons */
.app-icon{position:absolute;top:50%;left:50%;width:58px;height:58px;margin:-29px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:var(--glass);backdrop-filter:blur(20px) saturate(1.5);-webkit-backdrop-filter:blur(20px) saturate(1.5);border:1px solid var(--glass-border);box-shadow:0 4px 24px rgba(0,0,0,0.2);opacity:0;transform:scale(0) translate(0,0);transition:all .4s cubic-bezier(0.175,0.885,0.32,1.275);pointer-events:none;cursor:pointer;z-index:21}
.app-icon.visible{opacity:1;transform:scale(1) translate(var(--tx),var(--ty));pointer-events:auto}
.app-icon.launching{transition:transform .4s ease-in,opacity .3s ease-in;transform:scale(15) translate(0,0)!important;opacity:0!important}
.app-icon:active{transform:scale(0.92) translate(var(--tx),var(--ty))!important;background:rgba(0,102,255,0.15)}
.app-icon svg{width:24px;height:24px;stroke:rgba(255,255,255,0.7);stroke-width:1.5;fill:none}
.app-icon.top-app{border-color:rgba(0,200,255,0.2);box-shadow:0 4px 24px rgba(0,0,0,0.2),0 0 20px rgba(0,200,255,0.08)}
.app-label{position:absolute;bottom:-22px;left:50%;transform:translateX(-50%);font-size:10px;font-weight:300;letter-spacing:0.3px;color:rgba(255,255,255,0.4);white-space:nowrap}

/* Notification dot */
.notif-dot{position:absolute;top:-2px;right:-2px;width:8px;height:8px;border-radius:50%;animation:notifPulse 2s ease-in-out infinite}
@keyframes notifPulse{0%,100%{opacity:0.8;transform:scale(1)}50%{opacity:1;transform:scale(1.15)}}

/* Quick actions */
.quick-actions{position:absolute;top:50%;left:50%;pointer-events:none;z-index:25}
.quick-pill{position:absolute;background:rgba(255,255,255,0.07);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:8px 16px;font-size:11px;font-weight:300;color:rgba(255,255,255,0.7);white-space:nowrap;opacity:0;transform:scale(0.8);transition:all .25s cubic-bezier(0.175,0.885,0.32,1.275);pointer-events:none;cursor:pointer}
.quick-pill.visible{opacity:1;transform:scale(1) translate(var(--qx),var(--qy));pointer-events:auto}
.quick-pill:active{background:rgba(0,102,255,0.2)}

/* Voice UI */
.voice-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);opacity:0;pointer-events:none;transition:opacity .4s;z-index:5}
.voice-active~.voice-overlay{opacity:1}
.voice-text{position:fixed;bottom:18%;left:0;right:0;text-align:center;z-index:30;pointer-events:none}
.voice-status{font-size:12px;font-weight:200;color:rgba(0,212,255,.6);letter-spacing:4px;text-transform:uppercase;opacity:0;transition:opacity .3s;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:8px}
.voice-active~.voice-text .voice-status{opacity:1}
.listening-dot{width:6px;height:6px;border-radius:50%;background:var(--cyan);animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.8)}}
.voice-transcript{font-size:clamp(18px,4.5vw,24px);font-weight:300;color:var(--text);min-height:32px;padding:0 32px;opacity:0;transition:opacity .3s}
.voice-active~.voice-text .voice-transcript{opacity:1}
.voice-response{font-size:clamp(14px,3.5vw,17px);font-weight:300;color:rgba(255,255,255,.55);min-height:24px;padding:0 32px;margin-top:12px;opacity:0;transition:opacity .3s}
.voice-active~.voice-text .voice-response{opacity:1}

/* Launch color flash */
.launch-flash{position:fixed;inset:0;opacity:0;pointer-events:none;z-index:100;transition:opacity .15s}
.launch-flash.active{opacity:1}

/* Toast */
.toast{position:fixed;bottom:calc(env(safe-area-inset-bottom,20px) + 80px);left:50%;transform:translateX(-50%) translateY(20px);background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:12px;padding:10px 20px;font-size:13px;font-weight:300;color:rgba(255,255,255,.7);opacity:0;transition:all .3s;z-index:150;white-space:nowrap}
.toast.visible{opacity:1;transform:translateX(-50%) translateY(0)}

/* Info card */
.info-card{position:fixed;top:calc(50% + var(--orb-size)/2 - 30px);left:50%;transform:translateX(-50%) translateY(30px);width:280px;background:rgba(255,255,255,0.05);backdrop-filter:blur(30px) saturate(1.5);-webkit-backdrop-filter:blur(30px) saturate(1.5);border:1px solid rgba(255,255,255,0.06);border-radius:20px;padding:20px 24px;opacity:0;pointer-events:none;transition:all .3s ease-out;z-index:40}
.info-card.visible{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}
.info-card .time{font-size:32px;font-weight:200;color:#fff;line-height:1}
.info-card .date{font-size:13px;font-weight:300;color:rgba(255,255,255,.4);margin-top:4px}
.info-card .divider{height:1px;background:rgba(255,255,255,0.06);margin:16px 0}
.info-card .weather{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:300;color:rgba(255,255,255,.5)}
.info-card .weather svg{width:20px;height:20px;stroke:rgba(255,255,255,.5);fill:none}
.info-card .event{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:300;color:rgba(255,255,255,.4);margin-top:12px}
.info-card .event-dot{width:6px;height:6px;border-radius:50%;background:var(--cyan)}

/* Install banner */
.install-banner{position:fixed;bottom:0;left:16px;right:16px;background:rgba(255,255,255,0.05);backdrop-filter:blur(30px) saturate(1.5);-webkit-backdrop-filter:blur(30px) saturate(1.5);border:1px solid var(--glass-border);border-radius:16px;padding:20px 24px calc(env(safe-area-inset-bottom,16px) + 16px);z-index:200;transform:translateY(120%);transition:transform .4s cubic-bezier(.34,1.56,.64,1);text-align:center}
.install-banner.visible{transform:translateY(-16px)}
.install-banner h3{font-size:15px;font-weight:400;letter-spacing:1px;margin-bottom:6px}
.install-banner p{font-size:11px;color:var(--dim);margin-bottom:16px;font-weight:300}
.install-btn{background:rgba(0,102,255,0.2);color:#fff;border:1px solid rgba(0,102,255,0.3);padding:10px 28px;border-radius:24px;font-size:13px;font-weight:400;cursor:pointer;transition:all .2s}
.install-btn:active{transform:scale(.96);background:rgba(0,102,255,0.3)}
.install-dismiss{background:none;border:none;color:var(--dim);font-size:11px;margin-top:12px;cursor:pointer;padding:8px;font-weight:300}

/* Hint */
.hint{position:fixed;bottom:max(env(safe-area-inset-bottom,20px),20px);left:0;right:0;text-align:center;font-size:10px;font-weight:300;color:rgba(255,255,255,0.15);letter-spacing:1px;z-index:50;transition:opacity .5s}
.hint.hidden{opacity:0;pointer-events:none}

/* Brand */
.brand{position:fixed;bottom:calc(max(env(safe-area-inset-bottom,20px),20px) + 40px);left:0;right:0;text-align:center;font-size:10px;font-weight:300;letter-spacing:8px;text-transform:uppercase;color:rgba(255,255,255,.06);z-index:50}
</style>
</head>
<body>

<div class="status"><span id="clock"></span></div>
<div class="greeting" id="greeting"></div>
<div class="onboard-text" id="onboardText"></div>

<div class="orb-wrap" id="orbWrap">
  <div class="orb-shadow"></div>
  <div class="orb-glow" id="orbGlow"></div>
  <canvas id="orbCanvas"></canvas>
  <div class="radial-menu" id="radialMenu"></div>
  <div class="quick-actions" id="quickActions"></div>
</div>

<div class="voice-overlay"></div>
<div class="voice-text">
  <div class="voice-status" id="voiceStatus"><span>Listening</span><span class="listening-dot"></span></div>
  <div class="voice-transcript" id="voiceTranscript"></div>
  <div class="voice-response" id="voiceResponse"></div>
</div>

<div class="launch-flash" id="launchFlash"></div>
<div class="toast" id="toast"></div>

<div class="info-card" id="infoCard">
  <div class="time" id="infoTime">2:45 PM</div>
  <div class="date" id="infoDate">Thursday, Feb 12</div>
  <div class="divider"></div>
  <div class="weather" id="infoWeather">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
    <span>72°F</span>
  </div>
  <div class="event"><span class="event-dot"></span><span>Team standup · 3:00 PM</span></div>
</div>

<div class="install-banner" id="installBanner">
  <h3>Install ORB</h3>
  <p>Add to home screen for the full experience</p>
  <button class="install-btn" id="installBtn">Install</button>
  <button class="install-dismiss" id="installDismiss">Not now</button>
</div>

<div class="brand">O R B</div>
<div class="hint" id="hint">tap · apps &nbsp;&nbsp; hold · voice</div>

<script>
// ═══════════════════════════════════════════
// ICONS & APPS CONFIG
// ═══════════════════════════════════════════
const ICONS = {
  Phone: `<svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>`,
  Messages: `<svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>`,
  Camera: `<svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>`,
  Music: `<svg viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`,
  Mail: `<svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`,
  Map: `<svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
  Instagram: `<svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>`,
  Twitter: `<svg viewBox="0 0 24 24"><path d="M4 4l11.5 16h4.5l-11.5-16z"/><path d="M4 20l6.5-6.5"/><path d="M20 4l-6.5 6.5"/></svg>`
};

const APPS = [
  { icon:'Phone', name:'Phone', count:0, color:'#34C759', actions:['Call Recent','Voicemail'] },
  { icon:'Messages', name:'Messages', count:0, color:'#34C759', actions:['New Message','Unread'] },
  { icon:'Camera', name:'Camera', count:0, color:'#0066FF', actions:['Photo','Video','Selfie'] },
  { icon:'Music', name:'Spotify', count:0, color:'#1DB954', actions:['Resume','Discover'] },
  { icon:'Mail', name:'Gmail', count:0, color:'#FF3B30', actions:['Compose','Inbox'] },
  { icon:'Map', name:'Maps', count:0, color:'#0066FF', actions:['Home','Work','Search'] },
  { icon:'Instagram', name:'Instagram', count:0, color:'#E1306C', actions:['Feed','Stories','Create'] },
  { icon:'Twitter', name:'X', count:0, color:'#1DA1F2', actions:['Feed','Post','DMs'] }
];

// Load counts
try{const s=JSON.parse(localStorage.getItem('orb_counts')||'{}');APPS.forEach(a=>{if(s[a.name])a.count=s[a.name]})}catch(e){}
function saveCounts(){const o={};APPS.forEach(a=>o[a.name]=a.count);try{localStorage.setItem('orb_counts',JSON.stringify(o))}catch(e){}}

// Notification dots (randomized per session)
let notifications = {};
if(!sessionStorage.getItem('orb_notifs')){
  const candidates = ['Messages','Gmail','Instagram','X','Phone'];
  const selected = candidates.sort(()=>Math.random()-.5).slice(0,Math.floor(Math.random()*3)+1);
  selected.forEach(n=>notifications[n]=Math.floor(Math.random()*5)+1);
  sessionStorage.setItem('orb_notifs',JSON.stringify(notifications));
}else{
  notifications = JSON.parse(sessionStorage.getItem('orb_notifs'));
}

// ═══════════════════════════════════════════
// PARTICLE SPHERE SYSTEM
// ═══════════════════════════════════════════
const canvas = document.getElementById('orbCanvas');
const ctx = canvas.getContext('2d');
const orbWrap = document.getElementById('orbWrap');
const orbGlow = document.getElementById('orbGlow');

let W, H, CX, CY, RADIUS;
let particles = [];
let dpr = Math.min(window.devicePixelRatio || 1, 2);
const PHI = Math.PI * (3 - Math.sqrt(5)); // Golden angle
const PARTICLE_COUNT = /Mobile|Android/i.test(navigator.userAgent) ? 1200 : 1800;
const FOV = 300;

// State
let rotationY = 0, rotationX = 0;
let targetRotationSpeed = 1;
let rotationSpeed = 1;
let sphereScale = 1;
let targetSphereScale = 1;
let sphereRadiusMult = 1;
let particleBrightness = 1;
let isVoiceMode = false;
let voiceMorphProgress = 0;
let menuOpen = false;
let isTouched = false;
let audioLevel = 0;
let targetAudioLevel = 0;

function initCanvas() {
  const rect = orbWrap.getBoundingClientRect();
  W = rect.width;
  H = rect.height;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  CX = W / 2;
  CY = H / 2;
  RADIUS = Math.min(W, H) * 0.38;
}

function initParticles() {
  particles = [];
  for (let i = 0; i < PARTICLE_COUNT; i++) {
    // Fibonacci sphere distribution
    const y = 1 - (i / (PARTICLE_COUNT - 1)) * 2;
    const radiusAtY = Math.sqrt(1 - y * y);
    const theta = PHI * i;
    
    const hueRand = Math.random();
    let hue, sat, light;
    if (hueRand < 0.40) { hue = 190; sat = 100; light = 70; } // cyan
    else if (hueRand < 0.65) { hue = 220; sat = 100; light = 60; } // blue
    else if (hueRand < 0.85) { hue = 270; sat = 80; light = 65; } // violet
    else { hue = 200; sat = 30; light = 90; } // white-ish
    
    particles.push({
      baseX: Math.cos(theta) * radiusAtY,
      baseY: y,
      baseZ: Math.sin(theta) * radiusAtY,
      x: 0, y: 0, z: 0,
      size: 0.8 + Math.random() * 1.5,
      hue, sat, light,
      phase: Math.random() * Math.PI * 2,
      driftSpeed: 0.3 + Math.random() * 0.5,
      driftAmp: 0.015 + Math.random() * 0.02,
      isStar: Math.random() < 0.07,
      twinklePhase: Math.random() * Math.PI * 2
    });
  }
}

function updateParticle(p, time, deltaTime) {
  // Drift animation
  const drift = Math.sin(time * 0.001 * p.driftSpeed + p.phase) * p.driftAmp * (isTouched ? 2 : 1);
  const driftY = Math.sin(time * 0.0008 * p.driftSpeed + p.phase + 1) * p.driftAmp * 0.5;
  const driftZ = Math.sin(time * 0.0012 * p.driftSpeed + p.phase + 2) * p.driftAmp * 0.7;
  
  let x = p.baseX + drift;
  let y = p.baseY + driftY;
  let z = p.baseZ + driftZ;
  
  // Voice mode: morph to ring (torus)
  if (voiceMorphProgress > 0) {
    const ringY = y * (1 - voiceMorphProgress * 0.7); // Flatten Y
    const ringExpand = 1 + voiceMorphProgress * 0.15;
    const ringRadius = Math.sqrt(x * x + z * z);
    
    // Audio reactive displacement for ring
    if (voiceMorphProgress > 0.8 && ringRadius > 0.3) {
      const angle = Math.atan2(z, x);
      const segment = Math.floor((angle + Math.PI) / (Math.PI * 2) * 32);
      const audioDisp = audioLevel * 0.15 * Math.sin(time * 0.003 + segment * 0.5);
      const newRadius = ringRadius + audioDisp;
      x = Math.cos(angle) * newRadius * ringExpand;
      z = Math.sin(angle) * newRadius * ringExpand;
    } else {
      x *= ringExpand;
      z *= ringExpand;
    }
    y = ringY;
  }
  
  // Apply rotation
  const cosY = Math.cos(rotationY);
  const sinY = Math.sin(rotationY);
  const cosX = Math.cos(rotationX);
  const sinX = Math.sin(rotationX);
  
  // Rotate around Y
  let rx = x * cosY - z * sinY;
  let rz = x * sinY + z * cosY;
  // Rotate around X
  let ry = y * cosX - rz * sinX;
  rz = y * sinX + rz * cosX;
  
  p.x = rx;
  p.y = ry;
  p.z = rz;
}

function drawParticles(time) {
  ctx.clearRect(0, 0, W, H);
  
  // Sort by Z for proper depth
  particles.sort((a, b) => a.z - b.z);
  
  const baseRadius = RADIUS * sphereScale * sphereRadiusMult;
  
  // Enable additive blending for glow
  ctx.globalCompositeOperation = 'lighter';
  
  for (const p of particles) {
    const scale = FOV / (FOV + p.z * baseRadius);
    const screenX = CX + p.x * baseRadius * scale;
    const screenY = CY + p.y * baseRadius * scale;
    
    // Depth-based properties
    const depthAlpha = 0.3 + (p.z + 1) * 0.35;
    const depthSize = p.size * scale;
    const brightness = particleBrightness * (menuOpen ? 0.5 : 1);
    
    // Twinkle for stars
    let alpha = depthAlpha * brightness;
    if (p.isStar) {
      alpha *= 0.7 + Math.sin(time * 0.003 + p.twinklePhase) * 0.3;
    }
    
    // Voice mode brightness boost
    if (voiceMorphProgress > 0.5) {
      alpha *= 1 + voiceMorphProgress * 0.5;
    }
    
    // Glow pass
    const glowSize = depthSize * 3;
    ctx.beginPath();
    ctx.arc(screenX, screenY, glowSize, 0, Math.PI * 2);
    ctx.fillStyle = `hsla(${p.hue},${p.sat}%,${p.light}%,${alpha * 0.15})`;
    ctx.fill();
    
    // Core pass
    ctx.beginPath();
    ctx.arc(screenX, screenY, depthSize, 0, Math.PI * 2);
    ctx.fillStyle = `hsla(${p.hue},${p.sat}%,${p.light + 10}%,${alpha})`;
    ctx.fill();
  }
  
  ctx.globalCompositeOperation = 'source-over';
}

let lastTime = 0;
let burstParticles = [];

function animate(time) {
  const deltaTime = time - lastTime;
  lastTime = time;
  
  // Smooth state transitions
  rotationSpeed += (targetRotationSpeed - rotationSpeed) * 0.05;
  sphereScale += (targetSphereScale - sphereScale) * 0.08;
  sphereRadiusMult += ((isTouched ? 1.08 : 1) - sphereRadiusMult) * 0.1;
  audioLevel += (targetAudioLevel - audioLevel) * 0.15;
  
  // Voice morph transition
  if (isVoiceMode && voiceMorphProgress < 1) {
    voiceMorphProgress = Math.min(1, voiceMorphProgress + deltaTime * 0.002);
  } else if (!isVoiceMode && voiceMorphProgress > 0) {
    voiceMorphProgress = Math.max(0, voiceMorphProgress - deltaTime * 0.0025);
  }
  
  // Time-based rotation speed
  const hour = new Date().getHours();
  let ambientSpeed = 1;
  if (hour >= 22 || hour < 6) ambientSpeed = 0.5; // Night: slower
  else if (hour >= 6 && hour < 12) ambientSpeed = 0.8; // Morning: calm
  else if (hour >= 18) ambientSpeed = 0.7; // Evening
  
  // Rotation
  rotationY += deltaTime * 0.00003 * rotationSpeed * ambientSpeed;
  rotationX = Math.sin(time * 0.00005) * 0.08;
  
  // Breathing pulse
  targetSphereScale = 1 + Math.sin(time * 0.0008) * 0.02;
  
  // Update all particles
  for (const p of particles) {
    updateParticle(p, time, deltaTime);
  }
  
  // Update glow opacity with breathing
  orbGlow.style.opacity = 0.6 + Math.sin(time * 0.0008) * 0.2;
  
  drawParticles(time);
  requestAnimationFrame(animate);
}

// Initialize
initCanvas();
initParticles();
window.addEventListener('resize', () => { initCanvas(); });
requestAnimationFrame(animate);

// ═══════════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════════
function haptic(p){if(navigator.vibrate)navigator.vibrate(p)}
function showToast(msg, duration = 1500) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), duration);
}
function hideHint(){
  if(!localStorage.getItem('orb_hint_hidden')){
    document.getElementById('hint').classList.add('hidden');
    localStorage.setItem('orb_hint_hidden','true');
  }
}
if(localStorage.getItem('orb_hint_hidden'))document.getElementById('hint').classList.add('hidden');

// ═══════════════════════════════════════════
// RADIAL MENU
// ═══════════════════════════════════════════
const radialMenu = document.getElementById('radialMenu');
const quickActionsEl = document.getElementById('quickActions');
const launchFlash = document.getElementById('launchFlash');
let activeQuickAction = null;
let iconHoldTimers = {};

function buildMenu() {
  radialMenu.innerHTML = '';
  const sorted = [...APPS].sort((a,b) => b.count - a.count);
  const radius = orbWrap.offsetWidth * 0.75;
  
  sorted.forEach((app, i) => {
    const angle = (i / sorted.length) * Math.PI * 2 - Math.PI / 2;
    const tx = Math.cos(angle) * radius;
    const ty = Math.sin(angle) * radius;
    
    const el = document.createElement('div');
    el.className = 'app-icon' + (i === 0 && app.count > 0 ? ' top-app' : '');
    el.style.setProperty('--tx', tx + 'px');
    el.style.setProperty('--ty', ty + 'px');
    el.style.transitionDelay = (i * 30) + 'ms';
    el.dataset.app = app.name;
    el.dataset.angle = angle;
    
    let inner = ICONS[app.icon] + `<span class="app-label">${app.name}</span>`;
    
    // Notification dot
    if (notifications[app.name]) {
      const dotColor = app.name === 'Instagram' 
        ? 'background:linear-gradient(45deg,#FCAF45,#E1306C,#C13584)'
        : `background:${app.color}`;
      inner += `<span class="notif-dot" style="${dotColor}"></span>`;
    }
    
    el.innerHTML = inner;
    
    // Touch handling
    el.addEventListener('pointerdown', (e) => {
      e.stopPropagation();
      iconHoldTimers[app.name] = setTimeout(() => showQuickActions(app, el, angle), 400);
    });
    el.addEventListener('pointerup', (e) => {
      e.stopPropagation();
      clearTimeout(iconHoldTimers[app.name]);
      if (!activeQuickAction) {
        launchApp(app, el);
      }
    });
    el.addEventListener('pointerleave', () => clearTimeout(iconHoldTimers[app.name]));
    
    radialMenu.appendChild(el);
  });
}
buildMenu();

function showQuickActions(app, iconEl, angle) {
  haptic(15);
  closeQuickActions();
  activeQuickAction = app.name;
  
  const actions = app.actions || [];
  const baseAngle = angle + Math.PI; // Away from orb
  const arcSpread = 0.4;
  const dist = 75;
  
  actions.forEach((action, i) => {
    const pill = document.createElement('div');
    pill.className = 'quick-pill';
    const actionAngle = baseAngle + (i - (actions.length - 1) / 2) * arcSpread;
    const qx = Math.cos(actionAngle) * dist;
    const qy = Math.sin(actionAngle) * dist;
    pill.style.setProperty('--qx', qx + 'px');
    pill.style.setProperty('--qy', qy + 'px');
    pill.style.transitionDelay = (i * 30) + 'ms';
    pill.textContent = action;
    pill.addEventListener('click', (e) => {
      e.stopPropagation();
      haptic(20);
      showToast(`Opening ${action}...`);
      closeMenu();
    });
    quickActionsEl.appendChild(pill);
    requestAnimationFrame(() => pill.classList.add('visible'));
  });
}

function closeQuickActions() {
  activeQuickAction = null;
  quickActionsEl.innerHTML = '';
}

function openMenu() {
  if (menuOpen || isVoiceMode) return;
  menuOpen = true;
  haptic(15);
  hideHint();
  targetRotationSpeed = 0.3;
  buildMenu();
  requestAnimationFrame(() => {
    radialMenu.querySelectorAll('.app-icon').forEach(el => el.classList.add('visible'));
  });
}

function closeMenu() {
  if (!menuOpen) return;
  menuOpen = false;
  targetRotationSpeed = 1;
  closeQuickActions();
  const icons = radialMenu.querySelectorAll('.app-icon');
  icons.forEach((el, i) => {
    el.style.transitionDelay = ((icons.length - 1 - i) * 20) + 'ms';
    el.classList.remove('visible');
  });
}

function launchApp(app, iconEl) {
  haptic(25);
  app.count++;
  saveCounts();
  
  // Icon zoom animation
  iconEl.classList.add('launching');
  
  // Hide other icons
  radialMenu.querySelectorAll('.app-icon').forEach(el => {
    if (el !== iconEl) el.style.opacity = '0';
  });
  
  // Particle burst effect
  targetRotationSpeed = 3;
  sphereRadiusMult = 1.15;
  
  // Color flash
  launchFlash.style.background = app.color + '20';
  setTimeout(() => launchFlash.classList.add('active'), 200);
  setTimeout(() => launchFlash.classList.remove('active'), 400);
  
  // Reset
  setTimeout(() => {
    targetRotationSpeed = 1;
    sphereRadiusMult = 1;
    closeMenu();
    showToast(`${app.name} opened`);
  }, 450);
}

// ═══════════════════════════════════════════
// VOICE MODE
// ═══════════════════════════════════════════
const voiceStatus = document.getElementById('voiceStatus');
const voiceTranscript = document.getElementById('voiceTranscript');
const voiceResponse = document.getElementById('voiceResponse');
let recognition = null, recognizing = false;

function enterVoiceMode() {
  if (isVoiceMode) return;
  isVoiceMode = true;
  closeMenu();
  haptic([10,30,20,30,40]);
  hideHint();
  orbWrap.classList.add('voice-active');
  targetRotationSpeed = 0.5;
  voiceTranscript.textContent = '';
  voiceResponse.textContent = '';
  voiceStatus.querySelector('span').textContent = 'Listening';
  simulateAudio();
  startRecognition();
}

function exitVoiceMode() {
  isVoiceMode = false;
  orbWrap.classList.remove('voice-active');
  targetAudioLevel = 0;
  targetRotationSpeed = 1;
  if (recognition && recognizing) {
    recognizing = false;
    try { recognition.stop(); } catch(e) {}
  }
}

let audioSim;
function simulateAudio() {
  clearInterval(audioSim);
  audioSim = setInterval(() => {
    if (!isVoiceMode) { clearInterval(audioSim); return; }
    targetAudioLevel = 0.02 + Math.random() * 0.06;
  }, 100);
}

function startRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    voiceStatus.querySelector('span').textContent = 'Voice not supported';
    setTimeout(exitVoiceMode, 2000);
    return;
  }
  recognition = new SR();
  recognition.lang = 'en-US';
  recognition.interimResults = true;
  recognition.continuous = false;
  
  recognition.onstart = () => { recognizing = true; };
  recognition.onresult = (e) => {
    let interim = '', final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    voiceTranscript.textContent = final || interim;
    targetAudioLevel = 0.3 + Math.random() * 0.5;
    if (final) processCommand(final.trim().toLowerCase());
  };
  recognition.onerror = (e) => {
    if (e.error === 'not-allowed') {
      voiceStatus.querySelector('span').textContent = 'Mic access needed';
      setTimeout(exitVoiceMode, 2000);
    }
  };
  recognition.onend = () => {
    recognizing = false;
    targetAudioLevel = 0;
    if (isVoiceMode && !voiceTranscript.textContent) {
      try { recognition.start(); recognizing = true; } catch(e) {}
    }
  };
  try { recognition.start(); } catch(e) {}
}

function typeResponse(text, el) {
  el.textContent = '';
  let i = 0;
  const interval = setInterval(() => {
    if (i < text.length) { el.textContent += text[i]; i++; }
    else clearInterval(interval);
  }, 25);
}

function processCommand(cmd) {
  haptic([20,50,20]);
  voiceStatus.querySelector('span').textContent = 'Processing';
  targetAudioLevel = 0;
  
  let response = '';
  const openMatch = cmd.match(/(?:open|launch|start|show me|go to)\s+(.+)/);
  if (openMatch) {
    const target = openMatch[1];
    const found = APPS.find(a => a.name.toLowerCase().includes(target) || target.includes(a.name.toLowerCase()));
    if (found) {
      response = `Opening ${found.name}`;
      found.count++;
      saveCounts();
    } else {
      response = `Launching ${target}`;
    }
  } else if (cmd.includes('time') || cmd.includes('what time')) {
    response = `It's ${new Date().toLocaleTimeString([],{hour:'numeric',minute:'2-digit'})}`;
  } else if (cmd.includes('hello') || cmd.includes('hey') || cmd.includes('hi')) {
    response = "Hey there";
  } else {
    response = `Got it`;
  }
  
  setTimeout(() => {
    voiceStatus.querySelector('span').textContent = '';
    typeResponse(response, voiceResponse);
    if ('speechSynthesis' in window) {
      const utter = new SpeechSynthesisUtterance(response);
      utter.rate = 1.05;
      speechSynthesis.speak(utter);
    }
    setTimeout(exitVoiceMode, 2000);
  }, 400);
}

// ═══════════════════════════════════════════
// INFO CARD (Swipe up)
// ═══════════════════════════════════════════
const infoCard = document.getElementById('infoCard');
const infoTime = document.getElementById('infoTime');
const infoDate = document.getElementById('infoDate');
let infoCardVisible = false;
let infoCardTimeout = null;

function updateInfoCard() {
  const now = new Date();
  infoTime.textContent = now.toLocaleTimeString([],{hour:'numeric',minute:'2-digit'});
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  infoDate.textContent = `${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}`;
}

function showInfoCard() {
  if (menuOpen || isVoiceMode) return;
  updateInfoCard();
  infoCardVisible = true;
  infoCard.classList.add('visible');
  clearTimeout(infoCardTimeout);
  infoCardTimeout = setTimeout(hideInfoCard, 5000);
}

function hideInfoCard() {
  infoCardVisible = false;
  infoCard.classList.remove('visible');
}

infoCard.addEventListener('click', hideInfoCard);

// Swipe detection
let swipeStartY = 0, swipeStartTime = 0;
orbWrap.addEventListener('touchstart', (e) => {
  swipeStartY = e.touches[0].clientY;
  swipeStartTime = Date.now();
});
orbWrap.addEventListener('touchend', (e) => {
  const deltaY = e.changedTouches[0].clientY - swipeStartY;
  const duration = Date.now() - swipeStartTime;
  if (deltaY < -60 && duration < 400 && !menuOpen && !isVoiceMode) {
    showInfoCard();
  } else if (deltaY > 60 && infoCardVisible) {
    hideInfoCard();
  }
});

// ═══════════════════════════════════════════
// TOUCH HANDLING
// ═══════════════════════════════════════════
let touchStart = 0, holdTimer = null, didHold = false;

orbWrap.addEventListener('pointerdown', (e) => {
  if (isVoiceMode) { exitVoiceMode(); return; }
  if (infoCardVisible) { hideInfoCard(); return; }
  touchStart = Date.now();
  didHold = false;
  isTouched = true;
  targetRotationSpeed = 3;
  holdTimer = setTimeout(() => {
    didHold = true;
    enterVoiceMode();
  }, 500);
});

orbWrap.addEventListener('pointerup', (e) => {
  clearTimeout(holdTimer);
  isTouched = false;
  if (!isVoiceMode) targetRotationSpeed = 1;
  const dt = Date.now() - touchStart;
  if (!didHold && dt < 400 && !isVoiceMode) {
    if (menuOpen) { closeMenu(); closeQuickActions(); }
    else openMenu();
  }
});

orbWrap.addEventListener('pointerleave', () => {
  clearTimeout(holdTimer);
  isTouched = false;
  if (!isVoiceMode && !menuOpen) targetRotationSpeed = 1;
});

document.addEventListener('pointerdown', (e) => {
  if (menuOpen && !orbWrap.contains(e.target)) {
    closeMenu();
    closeQuickActions();
  }
});

// ═══════════════════════════════════════════
// ONBOARDING (first visit)
// ═══════════════════════════════════════════
const onboardText = document.getElementById('onboardText');

function runOnboarding() {
  if (localStorage.getItem('orb_onboarded')) return;
  
  // Start with particles at center
  particles.forEach(p => {
    p.baseX *= 0.01;
    p.baseY *= 0.01;
    p.baseZ *= 0.01;
  });
  
  // Expand outward
  setTimeout(() => {
    const expandDuration = 1500;
    const startTime = performance.now();
    
    function expand() {
      const elapsed = performance.now() - startTime;
      const progress = Math.min(1, elapsed / expandDuration);
      const eased = 1 - Math.pow(1 - progress, 3); // ease-out
      
      particles.forEach((p, i) => {
        const y = 1 - (i / (PARTICLE_COUNT - 1)) * 2;
        const radiusAtY = Math.sqrt(1 - y * y);
        const theta = PHI * i;
        p.baseX = Math.cos(theta) * radiusAtY * eased;
        p.baseY = y * eased;
        p.baseZ = Math.sin(theta) * radiusAtY * eased;
      });
      
      if (progress < 1) requestAnimationFrame(expand);
    }
    expand();
  }, 100);
  
  // Show text
  setTimeout(() => {
    onboardText.textContent = 'This is ORB';
    onboardText.style.opacity = '1';
  }, 800);
  
  setTimeout(() => {
    onboardText.textContent = 'Tap to explore · Hold to speak';
  }, 2800);
  
  setTimeout(() => {
    onboardText.style.opacity = '0';
    localStorage.setItem('orb_onboarded', 'true');
  }, 5000);
}

runOnboarding();

// ═══════════════════════════════════════════
// CLOCK & GREETING
// ═══════════════════════════════════════════
const clockEl = document.getElementById('clock');
const greetEl = document.getElementById('greeting');

function updateClock() {
  clockEl.textContent = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:true});
}
updateClock();
setInterval(updateClock, 10000);

(function setGreeting() {
  const h = new Date().getHours();
  greetEl.textContent = h < 12 ? 'Good morning' : h < 18 ? 'Good afternoon' : 'Good evening';
})();

// ═══════════════════════════════════════════
// PWA INSTALL
// ═══════════════════════════════════════════
let deferredPrompt;
const installBanner = document.getElementById('installBanner');
const installBtn = document.getElementById('installBtn');
const installDismiss = document.getElementById('installDismiss');
const isInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
const wasDismissed = localStorage.getItem('orb_install_dismissed');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if (!isInstalled && !wasDismissed) setTimeout(() => installBanner.classList.add('visible'), 4000);
});

installBtn.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') installBanner.classList.remove('visible');
    deferredPrompt = null;
  }
});

installDismiss.addEventListener('click', () => {
  installBanner.classList.remove('visible');
  localStorage.setItem('orb_install_dismissed', 'true');
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
